"use strict";const e=require("vue"),F=require("./ajax.js"),P=require("../../../utils/create.js"),y=require("../../../utils/utils.js"),M=require("./upload.js"),r=require("./utils.js"),T=require("./upload-picture-item.vue.js"),j=require("./upload-file-item.vue.js"),O=require("./upload-draggle.vue.js"),$=["accept","multiple"],G=e.defineComponent({name:"tl-upload",__name:"upload",props:{accept:{default:"*"},maxSize:{default:3*1024*1024},multiple:{type:Boolean,default:!0},limit:{default:0},uploadUrl:{default:""},shape:{default:"default"},fileList:{default:()=>[]},desc:{default:""},avatar:{type:Boolean,default:!1},draggable:{type:Boolean,default:!1}},emits:["handleSuccess","handleDelete","handleError","handleBeforeUpload"],setup(E,{emit:w}){const o=P.createNamespace("upload"),s=E,p=w,f=e.ref(!1),N=e.ref(!1);e.ref();const V=e.ref(!1),v=e.reactive({name:"",url:"",uid:y.generateUid(),status:"uploading"}),R=e.ref(0),n=e.ref(r.generateListUid(s.fileList)),k=e.ref(),h=new Map,g=e.computed(()=>n.value.length);e.computed(()=>n.value.map(l=>l.raw?URL.createObjectURL(l.raw):l.url));const i=e.computed(()=>!!s.limit&&g.value>=s.limit);f.value=M.ImageTypes.some(t=>s.accept.includes(t))||s.avatar;const{proxy:J}=e.getCurrentInstance(),z=(t,l)=>{console.log("success");const a=r.findFileByUid(t,n.value);n.value[a].status="success",p("handleSuccess",l,n.value)},q=(t,l)=>{const a=r.findFileByUid(t,n.value);n.value[a].progress=l},H=(t,l)=>{console.log(l,"error");const a=r.findFileByUid(t,n.value);n.value[a].status="error",p("handleError",l,n.value)},m=async()=>{var t;i.value||(t=k.value)==null||t.click()},b=t=>(p("handleBeforeUpload",t),!(s.maxSize&&t.size>s.maxSize||s.limit&&s.limit<=g.value)),L=t=>{const l=Array.from(t.target.files);if(l.length){if(s.avatar){b(l[0]),S(l[0]);return}l.forEach(a=>{const c=b(a);a&&c&&d(a)}),t.target.value=""}},d=async t=>{const l=t==null?void 0:t.name;if(!l)return;const a=y.generateUid();n.value.push({name:l,status:"uploading",raw:t,uid:a});const c={uid:a,uploadUrl:s.uploadUrl,selectedFile:t,fileName:l,onSuccess:z,onError:H,onProgress:q};h.set(a,F.UploadRequest(c))},S=t=>{n.value=[];const l=t==null?void 0:t.name;if(!l){console.log("error");return}const a=y.generateUid();v.name=l,v.raw=t,v.uid=a,V.value=!0,d(t)},C=t=>{const l=r.findFileByUid(t,n.value),a=h.get(t);a!=null&&a.abort&&(a.abort(),n.value[l].status="pause")},U=t=>{p("handleDelete",[r.findFileByUid(t,n.value),n.value]),n.value.splice(r.findFileByUid(t,n.value),1)},_=t=>{const l=r.findFileByUid(t,n.value),a=n.value[l].raw;n.value.splice(l,1),d(a)},A=(t,l)=>{const a=r.findFileByUid(l,n.value),c=n.value[a].name;n.value.splice(r.findFileByUid(l,n.value),1);const B=r.blobToFile(t,c);d(B)},D=t=>{const l=r.findFileByUid(t,n.value);R.value=l,N.value=!0},x=t=>{t.forEach(l=>{d(l)})};return(t,l)=>{const a=e.resolveComponent("tl-icon"),c=e.resolveComponent("tl-button"),B=e.resolveComponent("tl-text"),I=e.resolveComponent("tl-space");return e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass(e.unref(o).b())},[e.createElementVNode("input",{ref_key:"inputRef",ref:k,style:{display:"none"},accept:t.accept,multiple:t.multiple,type:"file",onChange:L,onClick:l[0]||(l[0]=e.withModifiers(()=>{},["stop"]))},null,40,$),f.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(o).e("files"))},[t.draggable?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(o).e("files-file"))},[e.createVNode(c,{class:e.normalizeClass(e.unref(o).e("files-file-button")),type:"secondary",disabled:i.value,onClick:m},{default:e.withCtx(()=>[e.createVNode(a,{icon:"fa-upload "}),l[1]||(l[1]=e.createElementVNode("span",null,"上传文件",-1))]),_:1},8,["class","disabled"]),e.createVNode(B,{type:"third"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(t.desc),1)]),_:1})],2)),t.draggable?(e.openBlock(),e.createElementBlock("div",{key:1,class:e.normalizeClass(e.unref(o).e("files-draggle-wrapper"))},[e.createVNode(O,{desc:t.desc,disabled:i.value,accept:t.accept,onHandleUpload:m,onHandleDraggleFiles:x},null,8,["desc","disabled","accept"])],2)):e.createCommentVNode("",!0),n.value.length?(e.openBlock(),e.createElementBlock("div",{key:2,class:e.normalizeClass(e.unref(o).e("files-list"))},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.value,u=>(e.openBlock(),e.createBlock(j,{key:u.uid,"file-content":u,progress:u.progress,onHandleRemove:U,onHandleReUpload:_,onHandleAbort:C},null,8,["file-content","progress"]))),128))],2)):e.createCommentVNode("",!0)],2)),f.value&&!t.draggable?(e.openBlock(),e.createBlock(I,{key:1,wrap:"",size:8},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.value,u=>(e.openBlock(),e.createElementBlock("span",{class:e.normalizeClass(e.unref(o).e("picture"))},[(e.openBlock(),e.createBlock(T,{key:u.uid,"file-content":u,"is-picture":f.value,progress:u.progress,shape:t.shape,avatar:t.avatar,onHandleRemove:U,onHandleReUpload:_,onHandleUpload:m,onHandleAbort:C,onHandleEdit:A,onHandleReview:D},null,8,["file-content","is-picture","progress","shape","avatar"]))],2))),256)),!(t.avatar&&g.value)&&!i.value?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass([e.unref(o).e("picture-button"),e.unref(o).is("disabled",i.value),e.unref(o).em("picture-button",t.shape)]),onClick:m},[e.createElementVNode("div",{class:e.normalizeClass(e.unref(o).e("picture-desc"))},[e.createVNode(a,{icon:"fa-plus",class:e.normalizeClass(e.unref(o).e("picture-button-icon"))},null,8,["class"]),t.desc?(e.openBlock(),e.createElementBlock("span",{key:0,class:e.normalizeClass(e.unref(o).e("picture-button-desc"))},e.toDisplayString(t.desc),3)):e.createCommentVNode("",!0)],2)],2)):e.createCommentVNode("",!0)]),_:1})):e.createCommentVNode("",!0)],2)}}});module.exports=G;
