"use strict";const a=require("vue"),z=require("../../../utils/create.js"),A=require("./tree.js"),D=require("./tree-node.vue.js"),M=require("./expand-transition.vue.js"),$=a.defineComponent({name:"tl-tree",__name:"tree",props:{data:{default:()=>[]},type:{},keyField:{default:"key"},labelField:{default:"label"},childrenField:{default:"children"},onLoad:{},fileTree:{type:Boolean,default:!1},selectable:{type:Boolean,default:!0},multiple:{type:Boolean,default:!1},showCheckbox:{type:Boolean,default:!1},selectedKeys:{default:()=>[]},defaultExpandedKeys:{default:()=>[]},defaultCheckedKeys:{default:()=>[]}},emits:["update:selectedKeys"],setup(C,{emit:w}){const B=z.createNamespace("tree"),r=C,v=a.ref([]);function L(e,t,l){return{getKey(n){return n[e]},getLabel(n){return n[t]},getChildren(n){return n[l]}}}const y=L(r.keyField,r.labelField,r.childrenField);function g(e,t=null){function l(s,i=null){return s.map(c=>{const k=y.getChildren(c)||[],p={key:y.getKey(c),label:y.getLabel(c),children:[],rawNode:c,disabled:c.disabled?c.disabled:!1,level:i?i.level+1:0,isLeaf:c.isLeaf??k.length==0,parentKey:i==null?void 0:i.key};return k.length>0&&(p.children=l(k,p)),p})}return l(e,t)}a.watch(()=>r.data,e=>{v.value=g(e)},{immediate:!0});const u=a.ref(new Set(r.defaultExpandedKeys)),K=a.computed(()=>{let e=u.value,t=[];const l=v.value||[],n=[];for(let s=l.length-1;s>=0;--s)n.push(l[s]);for(;n.length;){const s=n.pop();if(s&&(t.push(s),e.has(s.key))){const i=s.children;if(i)for(let c=i.length-1;c>=0;--c)n.push(s.children[c])}}return t});function N(e){return u.value.has(e.key)}const h=a.ref(new Set);function E(e){if(!e.children.length&&!e.isLeaf){const t=h.value;if(!t.has(e.key)){t.add(e.key);const l=r.onLoad;l&&l(e.rawNode).then(n=>{e.rawNode.children=n,e.children=g(n,e),t.delete(e.key)})}}}function S(e){u.value.delete(e.key)}function F(e){u.value.add(e.key),E(e)}function T(e){u.value.has(e.key)&&!h.value.has(e.key)?S(e):F(e)}const q=w,f=a.ref([]);a.watch(()=>r.selectedKeys,e=>{e&&(f.value=e)},{immediate:!0});function I(e){let t=Array.from(f.value);if(r.selectable){if(r.multiple){let l=t.findIndex(n=>n===e.key);l>-1?t.splice(l,1):t.push(e.key)}else t.includes(e.key)?t=[]:t=[e.key];f.value=t,q("update:selectedKeys",t)}}a.provide(A.TreeInjectKey,{slots:a.useSlots()});const d=a.ref(new Set(r.defaultCheckedKeys));function R(e){return d.value.has(e.key)}function O(e){return!!e.disabled}const o=a.ref(new Set);function j(e){return o.value.has(e.key)}function m(e,t){console.log("toggle",e,t);let l=d.value;t&&o.value.delete(e.key),l[t?"add":"delete"](e.key);let n=e.children;n&&n.forEach(s=>{s.disabled||m(s,t)})}function b(e){return K.value.find(t=>t.key===e)}function x(e){if(console.log("updateCheckKey",e,e.parentKey),e.parentKey){const t=b(e.parentKey);if(t){let l=!0,n=!1;const s=t.children;for(const i of s)if(d.value.has(i.key))n=!0;else if(o.value.has(i.key)){l=!1,n=!0;break}else if(l=!1,n==!0)break;l?(d.value.add(t.key),o.value.delete(t.key)):n&&(o.value.add(t.key),d.value.delete(t.key)),x(t)}}}function _(e,t){m(e,t),x(e)}return a.onMounted(()=>{r.defaultCheckedKeys.forEach(e=>{const t=b(e);t&&_(t,!0)})}),(e,t)=>(a.openBlock(),a.createElementBlock("div",{class:a.normalizeClass(a.unref(B).b())},[a.createVNode(M,null,{default:a.withCtx(()=>[(a.openBlock(!0),a.createElementBlock(a.Fragment,null,a.renderList(K.value,l=>(a.openBlock(),a.createBlock(D,{key:l.key,node:l,expanded:N(l),onToggle:T,onSelect:I,onCheck:_,"selected-keys":f.value,loadingKeys:h.value,"show-checkbox":e.showCheckbox,checked:R(l),disabled:O(l),indeterminate:j(l),"file-tree":e.fileTree},null,8,["node","expanded","selected-keys","loadingKeys","show-checkbox","checked","disabled","indeterminate","file-tree"]))),128))]),_:1})],2))}});module.exports=$;
